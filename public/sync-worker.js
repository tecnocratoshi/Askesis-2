function l(r,t){return typeof t=="bigint"?{__type:"bigint",val:t.toString()}:t instanceof Map?{__type:"map",val:Array.from(t.entries())}:t}function g(r,t){if(t&&typeof t=="object"){if(t.__type==="bigint")return BigInt(t.val);if(t.__type==="map")return new Map(t.val)}if(typeof t=="string"&&t.startsWith("0x"))try{return BigInt(t)}catch{return t}return t}async function y(r,t){let s=new TextEncoder,e=await crypto.subtle.importKey("raw",s.encode(r),{name:"PBKDF2"},!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function u(r,t){let s=JSON.stringify(r,l),e=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),i=await y(t,e),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},i,new TextEncoder().encode(s)),o=new Uint8Array(e.length+n.length+a.byteLength);return o.set(e),o.set(n,e.length),o.set(new Uint8Array(a),e.length+n.length),btoa(String.fromCharCode(...o))}async function d(r,t){let s=atob(r),e=new Uint8Array(s.length);for(let c=0;c<s.length;c++)e[c]=s.charCodeAt(c);let n=e.slice(0,16),i=e.slice(16,28),a=e.slice(28),o=await y(t,n),p=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},o,a);return JSON.parse(new TextDecoder().decode(p),g)}function f(r,t){let s={};for(let e in t){let n=t[e];if(typeof n=="string")try{n=JSON.parse(n)}catch{continue}let i=!1;for(let a in n)n[a][r]&&(delete n[a][r],i=!0),Object.keys(n[a]).length===0&&delete n[a];i&&(s[e]=Object.keys(n).length===0?"":JSON.stringify(n))}return s}self.onmessage=async r=>{let{id:t,type:s,payload:e,key:n}=r.data;try{let i;switch(s){case"encrypt":i=await u(e,n);break;case"decrypt":i=await d(e,n);break;case"build-ai-prompt":i=m(e);break;case"build-quote-analysis-prompt":i=h(e);break;case"archive":i=b(e);break;case"prune-habit":i=f(e.habitId,e.archives);break;default:throw new Error(`Task unknown: ${s}`)}self.postMessage({id:t,status:"success",result:i})}catch(i){self.postMessage({id:t,status:"error",error:i.message})}};function m(r){let{habits:t,dailyData:s,translations:e,languageName:n}=r,i="";return t.forEach(a=>{if(a.graduatedOn)return;let o=a.scheduleHistory[a.scheduleHistory.length-1].name||e[a.scheduleHistory[a.scheduleHistory.length-1].nameKey];i+=`- ${o}
`}),{prompt:e.promptTemplate.replace("{activeHabitDetails}",i).replace("{history}",JSON.stringify(s)),systemInstruction:e.aiSystemInstruction.replace("{languageName}",n)}}function h(r){return{prompt:r.translations.aiPromptQuote.replace("{notes}",r.notes).replace("{theme_list}",r.themeList),systemInstruction:r.translations.aiSystemInstructionQuote}}function b(r){let t={};for(let s in r){let e=r[s].base||{};if(typeof e=="string")try{e=JSON.parse(e)}catch{e={}}let n={...e,...r[s].additions};t[s]=JSON.stringify(n)}return t}
/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
